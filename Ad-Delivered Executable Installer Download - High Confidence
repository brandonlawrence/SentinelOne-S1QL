// Ad-Delivered Executable / Installer Download â€“ High Confidence
//
// Detects browser-initiated downloads of executable or archive files
// (.exe, .msi, .zip, .iso) delivered via online advertising infrastructure
// (gclid, adgroup_id, campaign_id).
//
// This behavior is strongly associated with malvertising-based initial
// access and frequently precedes malware execution, loader frameworks,
// or secondary payload delivery.
//
// Alert confidence increases further when correlated with execution
// shortly after download on the same endpoint.

event.category = "url" 
AND event.url.action = "GET" 
AND (
    (
        url.address contains ".exe/"
        OR url.address contains ".exe?"
        OR url.address endswith ".exe"

        OR url.address contains ".msi/"
        OR url.address contains ".msi?"
        OR url.address endswith ".msi"

        OR url.address contains ".msix/"
        OR url.address contains ".msix?"
        OR url.address endswith ".msix"

        OR url.address contains ".msixbundle/"
        OR url.address contains ".msixbundle?"
        OR url.address endswith ".msixbundle"

        OR url.address contains ".appx/"
        OR url.address contains ".appx?"
        OR url.address endswith ".appx"

        OR url.address contains ".appxbundle/"
        OR url.address contains ".appxbundle?"
        OR url.address endswith ".appxbundle"

        OR url.address contains ".zip/"
        OR url.address contains ".zip?"
        OR url.address endswith ".zip"

        OR url.address contains ".iso/"
        OR url.address contains ".iso?"
        OR url.address endswith ".iso"

        OR url.address contains ".scr/"
        OR url.address contains ".scr?"
        OR url.address endswith ".scr"

        OR url.address contains ".bat/"
        OR url.address contains ".bat?"
        OR url.address endswith ".bat"

        OR url.address contains ".cmd/"
        OR url.address contains ".cmd?"
        OR url.address endswith ".cmd"
    )
    AND (
        url.address contains "campaign_id"
        OR url.address contains "adgroup_id"
        OR url.address contains "gclid"
        OR url.address contains "clickid="
    )
)
AND NOT (
    url.address contains "utm_campaign="
    OR url.address contains "utm_medium=email"
    OR url.address matches "https?://www\\.zip[a-z0-9-]*\\.com/"
    OR url.address matches "https?://www\\.iso[a-z0-9-]*\\.com/"
    OR url.address matches "https?://www\\.msi[a-z0-9-]*\\.com/"
    OR url.address matches "https?://www\\.exe[a-z0-9-]*\\.com/"
)
